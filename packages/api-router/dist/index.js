module.exports=function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=1)}([function(e,t,r){"use strict";var n,o=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),s=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(o,s){function i(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){e.done?o(e.value):new r(function(t){t(e.value)}).then(i,a)}c((n=n.apply(e,t||[])).next())})},i=this&&this.__generator||function(e,t){var r,n,o,s,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;i;)try{if(r=1,n&&(o=2&s[0]?n.return:s[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,s[1])).done)return o;switch(n=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,n=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(o=(o=i.trys).length>0&&o[o.length-1])&&(6===s[0]||2===s[0])){i=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){i.label=s[1];break}if(6===s[0]&&i.label<o[1]){i.label=o[1],o=s;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(s);break}o[2]&&i.ops.pop(),i.trys.pop();continue}s=t.call(e,i)}catch(e){s=[6,e],n=0}finally{r=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},a=this&&this.__values||function(e){var t="function"==typeof Symbol&&e[Symbol.iterator],r=0;return t?t.call(e):{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}}},c=this&&this.__read||function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,s=r.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)i.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(o)throw o.error}}return i};Object.defineProperty(t,"__esModule",{value:!0});var u=function(e){function t(t,r){var n=e.call(this,""+(("string"==typeof t?t:r)||"")||"Security Error.")||this;return n.code=401,n.type="SecurityError",n.code="number"==typeof t?t:401,n}return o(t,e),t}(Error);t.SecurityError=u;var l=function(){function e(e){this.options=e,this.type="ApiSecurity"}return e.prototype.result=function(e){if("boolean"==typeof e)return e;if("string"==typeof e)throw new u(e);if(!e)throw new u;throw e.type="SecurityError",e},e.prototype.check=function(e,t,r){return s(this,void 0,void 0,function(){var n,o,s,l,p,h,f,y,d,v,b,m,g,w,_,x,k,S,O,P,j,A,M,R,E,H,I,U,C,T,z,N,q,L,B;return i(this,function(i){switch(i.label){case 0:if(!this.options.controller)throw new u("operation secuity define but no options.security controller.");p=!0,i.label=1;case 1:i.trys.push([1,35,36,37]),h=a(t.security),f=h.next(),i.label=2;case 2:if(f.done)return[3,34];y=f.value,i.label=3;case 3:i.trys.push([3,30,31,32]),d=a(Object.keys(y)),v=d.next(),i.label=4;case 4:if(v.done)return[3,29];if(b=v.value,!this.options.controller[b])throw new u("options.security controller without security function "+b+".");if(!(m=e&&e[b]))throw new u("component securitySchemes without "+b+" define.");switch(g=m.type.toLowerCase(),g){case"apikey":return[3,5];case"http":return[3,8];case"oauth2":return[3,19];case"openidconnect":return[3,22]}return[3,25];case 5:return(w=p)?(_=this.result,[4,this.options.controller[b]({apiKey:r.connection.parameters[m.in]&&r.connection.parameters[m.in][m.name]},r)]):[3,7];case 6:w=_.apply(this,[i.sent()]),i.label=7;case 7:return p=w,[3,28];case 8:switch(x=m.scheme.toLowerCase(),x){case"basic":return[3,9];case"bearer":return[3,12];case"digest":case"hoba":case"mutual":case"negotiate":case"oauth":case"scram-sha-1":case"scram-sha-256":case"vapid":return[3,15]}return[3,15];case 9:return k=(r.connection.parameters.header.Authorization||"").replace("Basic","").trim(),S=c(new Buffer(k,"base64").toString("utf8").split(":"),2),O=S[0],P=S[1],(j=p)?(A=this.result,[4,this.options.controller[b]({userId:O,password:P},r)]):[3,11];case 10:j=A.apply(this,[i.sent()]),i.label=11;case 11:return p=j,[3,18];case 12:return M=(r.connection.parameters.header.Authorization||"").replace("Bearer","").trim(),(R=p)?(E=this.result,[4,this.options.controller[b]({token:M,format:m.bearerFormat},r)]):[3,14];case 13:R=E.apply(this,[i.sent()]),i.label=14;case 14:return p=R,[3,18];case 15:return(H=p)?(I=this.result,[4,this.options.controller[b]({schema:m.scheme,requirement:y[b]},r)]):[3,17];case 16:H=I.apply(this,[i.sent()]),i.label=17;case 17:return p=H,[3,18];case 18:return[3,28];case 19:return(U=p)?(C=this.result,[4,this.options.controller[b]({flows:m.flows,scopes:y[b]},r)]):[3,21];case 20:U=C.apply(this,[i.sent()]),i.label=21;case 21:return p=U,[3,28];case 22:return(T=p)?(z=this.result,[4,this.options.controller[b]({openIdConnectUrl:m.openIdConnectUrl,scopes:y[b]},r)]):[3,24];case 23:T=z.apply(this,[i.sent()]),i.label=24;case 24:return p=T,[3,28];case 25:return(N=p)?(q=this.result,[4,this.options.controller[b]({schema:m,requirement:y[b],parameters:r.connection.parameters},r)]):[3,27];case 26:N=q.apply(this,[i.sent()]),i.label=27;case 27:return p=N,[3,28];case 28:return v=d.next(),[3,4];case 29:return[3,32];case 30:return L=i.sent(),s={error:L},[3,32];case 31:try{v&&!v.done&&(l=d.return)&&l.call(d)}finally{if(s)throw s.error}return[7];case 32:if(p)return[3,34];i.label=33;case 33:return f=h.next(),[3,2];case 34:return[3,37];case 35:return B=i.sent(),n={error:B},[3,37];case 36:try{f&&!f.done&&(o=h.return)&&o.call(h)}finally{if(n)throw n.error}return[7];case 37:return[2,p]}})})},e}();t.ApiSecurity=l},function(e,t,r){"use strict";function n(e){for(var r in e)t.hasOwnProperty(r)||(t[r]=e[r])}Object.defineProperty(t,"__esModule",{value:!0}),n(r(2)),n(r(0))},function(e,t,r){"use strict";var n,o=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),s=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(o,s){function i(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){e.done?o(e.value):new r(function(t){t(e.value)}).then(i,a)}c((n=n.apply(e,t||[])).next())})},i=this&&this.__generator||function(e,t){var r,n,o,s,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;i;)try{if(r=1,n&&(o=2&s[0]?n.return:s[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,s[1])).done)return o;switch(n=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,n=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(o=(o=i.trys).length>0&&o[o.length-1])&&(6===s[0]||2===s[0])){i=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){i.label=s[1];break}if(6===s[0]&&i.label<o[1]){i.label=o[1],o=s;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(s);break}o[2]&&i.ops.pop(),i.trys.pop();continue}s=t.call(e,i)}catch(e){s=[6,e],n=0}finally{r=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},a=this&&this.__rest||function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&(r[n[o]]=e[n[o]])}return r},c=this&&this.__values||function(e){var t="function"==typeof Symbol&&e[Symbol.iterator],r=0;return t?t.call(e):{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}}};Object.defineProperty(t,"__esModule",{value:!0});var u=r(3),l=r(0),p=function(e){function t(t,r,n){void 0===n&&(n="ApiError");var o=e.call(this,""+(r||"")||"Internal Server Error")||this;return o.type=n,o.code=t||500,o}return o(t,e),t}(Error);t.ApiError=p;var h,f=function(){return function(e,t){void 0===t&&(t=200),this.result=e,this.code=t}}();t.ApiResult=f,function(e){e.get="get",e.head="head",e.post="post",e.delete="delete",e.trace="trace",e.options="options",e.connect="connect",e.patch="patch"}(t.Methods||(t.Methods={})),function(e){e.starting="starting",e.routing="routing",e.resulted="resulted",e.unauthorized="unauthorized",e.exception="exception",e.responding="responding"}(h=t.hooks||(t.hooks={}));var y=function(){function e(e){var t,r,n=this;if(this.options=e,this.setContextHandlers=[],this._registerHandlers=[],this._parsers={integer:{default:[function(e,t,r){return s(n,void 0,void 0,function(){return i(this,function(t){return[2,Math.floor(Number(e))]})})}]},number:{default:[function(e,t,r){return s(n,void 0,void 0,function(){return i(this,function(t){return[2,Number(e)]})})}]},boolean:{default:[function(e,t,r){return s(n,void 0,void 0,function(){return i(this,function(t){return[2,"string"!=typeof e?!!e||e:!{"":!0,false:!0,0:!0}[e.toLowerCase()]]})})}]},string:{default:[function(e,t,r){return s(n,void 0,void 0,function(){return i(this,function(t){return[2,e]})})}]},array:{default:[function(e,t,r){return s(n,void 0,void 0,function(){var n,o,s,a,c,u,l,p;return i(this,function(i){switch(i.label){case 0:if(!e||"string"!=typeof e)return[2,void 0];if("json"===t.style){if(n=JSON.parse(e),!Array.isArray(n))throw"parameter is not array with JSON style";return[2,n]}if(o="json","query"===t.in)if("form"===t.style){if(t.explode)throw" not support multi type array";o="csv"}else o="spaceDelimited"===t.style?"ssv":"pipeDelimited"===t.style?"pipes":(t.style,"csv");else"path"!==t.in&&"header"!==t.in||"simple"!==t.style||(o="csv");if(s=t.schema,"array"===(a=s.items).type)throw"not support nest array.";c=e.split({csv:",",ssv:" ",pipes:"|"}[o]||","),u=0,i.label=1;case 1:return u<c.length?(l=c,p=u,[4,this.toParse(c[u],a.type||"string",a.format,t,r)]):[3,4];case 2:l[p]=i.sent(),i.label=3;case 3:return u++,[3,1];case 4:return[2,c]}})})}]},object:{default:[function(e,t,r){return s(n,void 0,void 0,function(){return i(this,function(t){return[2,JSON.parse(e)]})})}]}},this._hookHdls={},this.basePath=decodeURI(new u.URL(e.apiInterface.serverUrl,"http://localhost").pathname).replace(/\/$/,""),e.parsers&&e.parsers.length&&this.setParser(e.parsers),e.statusMap||(e.statusMap={}),e.security&&(this.security="ApiSecurity"===e.security.type?e.security:new l.ApiSecurity({controller:e.security})),e.plugins&&e.plugins.length)try{for(var o=c(e.plugins),a=o.next();!a.done;a=o.next()){var p=a.value;this.setPlugin(p)}}catch(e){t={error:e}}finally{try{a&&!a.done&&(r=o.return)&&r.call(o)}finally{if(t)throw t.error}}e.controller.apiRouterRegister&&e.controller.apiRouterRegister(this)}return e.prototype.setContext=function(e){this.setContextHandlers.push(e)},e.prototype.setParser=function(e,t,r){var n,o,s=Array.isArray(e)?e:[{type:e,format:t,parser:r}];try{for(var i=c(s),a=i.next();!a.done;a=i.next()){var u=a.value,l=u.format||"default";this._parsers[u.type]=this._parsers[u.type]||{default:[]},this._parsers[u.type][l]=this._parsers[u.type][l]||[],this._parsers[u.type][l].unshift(u.parser)}}catch(e){n={error:e}}finally{try{a&&!a.done&&(o=i.return)&&o.call(i)}finally{if(n)throw n.error}}},e.prototype.setOperation=function(e){this._registerHandlers.push(e)},e.prototype.setStatusCode=function(e,t){this.options.statusMap[e]=t},e.prototype.setPlugin=function(e){e.apiRouterRegister&&e.apiRouterRegister(this)},e.prototype.toParse=function(e,t,r,n,o){return s(this,void 0,void 0,function(){var s,a,u,l,p,h,f,y;return i(this,function(i){switch(i.label){case 0:u=[],this._parsers[t]&&(u=u.concat(this._parsers[t].default)),this._parsers[t]&&this._parsers[t][r]&&(u=this._parsers[t][r].concat(u)),i.label=1;case 1:i.trys.push([1,8,9,10]),l=c(u),p=l.next(),i.label=2;case 2:if(p.done)return[3,7];h=p.value,i.label=3;case 3:return i.trys.push([3,5,,6]),[4,h(e,n,o)];case 4:return[2,i.sent()];case 5:return f=i.sent(),console.log("parameter parse error",f),[3,6];case 6:return p=l.next(),[3,2];case 7:return[3,10];case 8:return y=i.sent(),s={error:y},[3,10];case 9:try{p&&!p.done&&(a=l.return)&&a.call(l)}finally{if(s)throw s.error}return[7];case 10:return console.log("unable parse parameter value: "+e+", type: "+t+", format: "+(r||"")+"."),[2,void 0]}})})},e.prototype.parseParameters=function(e,t){return s(this,void 0,void 0,function(){var r,n,o,s,a,u,l,p;return i(this,function(i){switch(i.label){case 0:t.parameters={},i.label=1;case 1:i.trys.push([1,6,7,8]),o=c(e),s=o.next(),i.label=2;case 2:return s.done?[3,5]:(a=s.value,(u=t.connection.parameters[a.in])&&a.schema&&a.schema.type?(t.parameters[a.in]=t.parameters[a.in]||{},[4,this.toParse(u[a.name],a.schema.type,a.schema.format,a,t)]):[3,4]);case 3:void 0!==(l=i.sent())&&(t.parameters[a.in][a.name]=l),i.label=4;case 4:return s=o.next(),[3,2];case 5:return[3,8];case 6:return p=i.sent(),r={error:p},[3,8];case 7:try{s&&!s.done&&(n=o.return)&&n.call(o)}finally{if(r)throw r.error}return[7];case 8:return[2,t.parameters]}})})},e.prototype.hookUp=function(e,t,r){void 0===r&&(r="last"),!this._hookHdls[e]&&(this._hookHdls[e]=[]),this._hookHdls[e]["first"===r?"unshift":"push"](t)},e.prototype._hooking=function(e,t,r){return s(this,void 0,void 0,function(){return i(this,function(n){switch(n.label){case 0:return this._hookHdls[e]?[4,Promise.all(this._hookHdls[e].map(function(e){return e(t,r)}))]:[3,2];case 1:n.sent(),n.label=2;case 2:return[2]}})})},e.prototype.preRouting=function(e,t){void 0===t&&(t=!1),t?this.hookUp(h.starting,e,"first"):this.hookUp(h.routing,e)},e.prototype.postRouted=function(e,t){void 0===t&&(t=!1),t?this.hookUp(h.responding,e):this.hookUp(h.resulted,e)},e.prototype.onError=function(e){this.hookUp(h.exception,e)},e.prototype.registerApis=function(e){var t,r,n=this,o=function(t){var r=u._registerHandlers.length?u._registerHandlers.reduce(function(e,t){return t(e.api,e.connector)},{api:t,connector:e}):{api:t,connector:e},o=r.api,p=r.connector;p.registerApi(u.basePath,o.path,o.method,function(e){return s(n,void 0,void 0,function(){var t,r,n,s,u,f,y,d,v,b,m,g,w,_,x;return i(this,function(i){switch(i.label){case 0:var k=e.send,S=a(e,["send"]);n={apiInterface:this.options.apiInterface,controller:this.options.controller,basePath:this.basePath,api:o,parameters:void 0,code:void 0,result:void 0,error:void 0,responded:!1,connector:p},S.send=function(e){n.responded||(n.responded=!0,k({code:e.code,contentType:e.contentType,result:void 0!==e.result?e.result:e.message}))},n.connection=S,i.label=1;case 1:i.trys.push([1,11,,12]);try{for(s=c(this.setContextHandlers),u=s.next();!u.done;u=s.next())(f=u.value)instanceof Function&&f(n)}catch(e){t={error:e}}finally{try{u&&!u.done&&(r=s.return)&&r.call(s)}finally{if(t)throw t.error}}return[4,this._hooking(h.starting,n)];case 2:return i.sent(),(y=o.operation.security&&o.operation.security.length)?(d=!this.security)?[3,4]:[4,this.security.check(this.options.apiInterface.security,o.operation,n)]:[3,5];case 3:d=!i.sent(),i.label=4;case 4:y=d,i.label=5;case 5:if(y)throw new l.SecurityError;return[4,this.parseParameters(o.operation.parameters,n)];case 6:return v=i.sent(),b=v.body,m=a(v,["body"]),n.parameters=m,n.body=b,[4,this._hooking(h.routing,n)];case 7:return i.sent(),(w=this.options.controller[o.operation.operationId])?[4,this.options.controller[o.operation.operationId](n.parameters,n.body,n)]:[3,9];case 8:w=i.sent(),i.label=9;case 9:return(g=w)&&(n.responded=!!g.responded,n.code="string"==typeof g.code&&this.options.statusMap[g.code]||"number"==typeof+g.code&&+g.code||this.options.statusMap.default||200,n.contentType=g.contentType,n.result=void 0!==g.result?g.result:g.message),[4,this._hooking(h.resulted,n)];case 10:return i.sent(),[3,12];case 11:return _=i.sent(),n.error=_,n.code="string"==typeof _.code&&this.options.statusMap[_.code]||"number"==typeof+_.code&&+_.code||this.options.statusMap.default||500,n.result="string"==typeof _?_:_&&_.message||"ApiRouter process error.",[3,12];case 12:return i.trys.push([12,18,,19]),n.error?"SecurityError"!==n.error.type?[3,14]:[4,this._hooking(h.unauthorized,n,n.error).catch(function(e){return console.error(e)})]:[3,16];case 13:i.sent(),i.label=14;case 14:return[4,this._hooking(h.exception,n,n.error).catch(function(e){return console.error(e)})];case 15:i.sent(),i.label=16;case 16:return[4,this._hooking(h.responding,n).catch(function(e){return console.error(e)})];case 17:return i.sent(),[3,19];case 18:return x=i.sent(),n.error=x,n.code="string"==typeof x.code&&this.options.statusMap[x.code]||"number"==typeof+x.code&&+x.code||this.options.statusMap.default||500,n.result="string"==typeof x?x:x&&x.message||"ApiRouter process error.#2",[3,19];case 19:return[2,{responded:n.responded,code:n.code,contentType:n.contentType,result:n.result}]}})})})},u=this;try{for(var p=c(this.options.apiInterface.operations),f=p.next();!f.done;f=p.next()){o(f.value)}}catch(e){t={error:e}}finally{try{f&&!f.done&&(r=p.return)&&r.call(p)}finally{if(t)throw t.error}}return e},e}();t.ApiRouter=y},function(e,t){e.exports=require("url")}]);